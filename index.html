<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clangen Save Editor</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        h1 { color: #a8dadc; margin-bottom: 20px; }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        input[type="file"] { display: none; }
        .file-label, .cat-select {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid #457b9d;
            background: #1d3557;
            color: #eee;
            font-size: 14px;
            cursor: pointer;
        }
        .file-label:hover, .cat-select:hover { background: #264b73; }
        .cat-select { min-width: 200px; }
        .cat-select:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { color: #a8dadc; font-size: 14px; }
        .placeholder-box {
            background: #16213e;
            border: 1px solid #457b9d;
            border-radius: 8px;
            padding: 20px;
            color: #888;
            font-style: italic;
        }
        #editorSection { display: none; }
        .form-grid {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 8px 12px;
            align-items: center;
            background: #16213e;
            border: 1px solid #457b9d;
            border-radius: 8px;
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .form-grid label {
            font-size: 13px;
            color: #a8dadc;
            text-align: right;
        }
        .form-grid input[type="text"],
        .form-grid input[type="number"],
        .form-grid select {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #457b9d;
            background: #1d3557;
            color: #eee;
            font-size: 13px;
            width: 100%;
        }
        .form-grid input:focus, .form-grid select:focus {
            outline: none;
            border-color: #a8dadc;
        }
        .form-grid input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .form-grid .display-only {
            color: #888;
            font-size: 13px;
        }
        .form-grid .compound {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .form-grid .compound input[type="number"] {
            width: 60px;
        }
        .form-grid .compound select {
            flex: 1;
        }
        
        /* Array field styles */
        .array-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .array-entry {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .array-entry select {
            flex: 1;
        }
        .array-btn {
            width: 26px;
            height: 26px;
            border-radius: 4px;
            border: 1px solid #457b9d;
            background: #1d3557;
            color: #eee;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }
        .array-btn:hover {
            background: #264b73;
        }
        .array-btn.remove {
            color: #e76f6f;
        }
        .array-btn.remove:hover {
            background: #4a2020;
            border-color: #e76f6f;
        }
        .array-btn.add {
            color: #6fe78a;
        }
        .array-btn.add:hover {
            background: #1a4a20;
            border-color: #6fe78a;
        }
        .array-add-row {
            display: flex;
            justify-content: flex-start;
        }
    </style>
</head>
<body>
    <h1>Clangen Save Editor</h1>
    
    <div class="controls">
        <label class="file-label">
            Load Save File
            <input type="file" id="fileInput" accept=".json">
        </label>
        <select id="catSelect" class="cat-select" disabled>
            <option value="">-- Select a cat --</option>
        </select>
        <span class="status" id="status"></span>
    </div>
    
    <div id="placeholderBox" class="placeholder-box">
        Load a clan_cats.json file to view cat data.
    </div>
    
    <div id="editorSection">
        <div class="form-grid" id="formGrid"></div>
    </div>

    <script src="dropdown-options.js"></script>
    <script src="field-definitions.js"></script>
    <script>
        let catsData = [];
        let currentCatIndex = null;
        
        const fileInput = document.getElementById('fileInput');
        const catSelect = document.getElementById('catSelect');
        const placeholderBox = document.getElementById('placeholderBox');
        const editorSection = document.getElementById('editorSection');
        const formGrid = document.getElementById('formGrid');
        const status = document.getElementById('status');
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    catsData = JSON.parse(event.target.result);
                    populateCatSelect();
                    status.textContent = `Loaded ${catsData.length} cats`;
                    placeholderBox.textContent = 'Select a cat from the dropdown.';
                    placeholderBox.style.display = 'block';
                    editorSection.style.display = 'none';
                } catch (err) {
                    status.textContent = 'Error parsing JSON';
                    placeholderBox.textContent = `Error: ${err.message}`;
                }
            };
            reader.readAsText(file);
        });
        
        function populateCatSelect() {
            catSelect.innerHTML = '<option value="">-- Select a cat --</option>';
            catsData.forEach((cat, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `${cat.ID} - ${cat.name_prefix}${cat.name_suffix}`;
                catSelect.appendChild(opt);
            });
            catSelect.disabled = false;
        }
        
        catSelect.addEventListener('change', (e) => {
            if (e.target.value === '') {
                placeholderBox.style.display = 'block';
                editorSection.style.display = 'none';
                currentCatIndex = null;
                return;
            }
            currentCatIndex = parseInt(e.target.value);
            renderForm(catsData[currentCatIndex]);
            placeholderBox.style.display = 'none';
            editorSection.style.display = 'block';
        });
        
        function getValue(obj, key) {
            if (key.includes('.')) {
                const parts = key.split('.');
                let v = obj;
                for (const p of parts) {
                    if (v == null) return null;
                    v = v[p];
                }
                return v;
            }
            return obj[key];
        }
        
        // Create a dropdown for an array entry
        function createArrayDropdown(key, options, selectedValue) {
            const select = document.createElement('select');
            select.dataset.key = key;
            select.dataset.arrayItem = 'true';
            
            // Blank option at the top
            const blankOpt = document.createElement('option');
            blankOpt.value = '';
            blankOpt.textContent = '-- Select --';
            select.appendChild(blankOpt);
            
            for (const optVal of options) {
                const opt = document.createElement('option');
                opt.value = optVal;
                opt.textContent = optVal;
                if (optVal === selectedValue) opt.selected = true;
                select.appendChild(opt);
            }
            
            return select;
        }
        
        // Create remove button
        function createRemoveButton(container, entryRow) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'array-btn remove';
            btn.textContent = 'âˆ’';
            btn.title = 'Remove this entry';
            btn.addEventListener('click', () => {
                entryRow.remove();
            });
            return btn;
        }
        
        // Create an array entry row (dropdown + remove button)
        function createArrayEntryRow(container, key, options, value) {
            const row = document.createElement('div');
            row.className = 'array-entry';
            
            const select = createArrayDropdown(key, options, value);
            row.appendChild(select);
            
            const removeBtn = createRemoveButton(container, row);
            row.appendChild(removeBtn);
            
            return row;
        }
        
        // Create the add button row
        function createAddButtonRow(container, key, options) {
            const row = document.createElement('div');
            row.className = 'array-add-row';
            
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'array-btn add';
            btn.textContent = '+';
            btn.title = 'Add new entry';
            btn.addEventListener('click', () => {
                // Insert new entry row before the add button row
                const newEntry = createArrayEntryRow(container, key, options, '');
                container.insertBefore(newEntry, row);
            });
            
            row.appendChild(btn);
            return row;
        }
        
        // Build the full array field container
        function createDropdownArrayField(key, options, values) {
            const container = document.createElement('div');
            container.className = 'array-field';
            container.dataset.key = key;
            container.dataset.arrayField = 'true';
            
            // Create entry rows for existing values
            const arr = Array.isArray(values) ? values : [];
            for (const val of arr) {
                const row = createArrayEntryRow(container, key, options, val);
                container.appendChild(row);
            }
            
            // Add the "+" button row at the bottom
            const addRow = createAddButtonRow(container, key, options);
            container.appendChild(addRow);
            
            return container;
        }
        
        function renderForm(cat) {
            formGrid.innerHTML = '';
            
            for (const [key, def] of Object.entries(FIELD_DEFS)) {
                const val = getValue(cat, key);
                
                const lbl = document.createElement('label');
                lbl.textContent = key;
                formGrid.appendChild(lbl);
                
                let input;
                
                switch (def.inputType) {
                    case 'display':
                        input = document.createElement('span');
                        input.className = 'display-only';
                        input.textContent = val ?? '';
                        break;
                        
                    case 'text':
                        input = document.createElement('input');
                        input.type = 'text';
                        input.value = val ?? '';
                        if (def.nullable) input.placeholder = '(none)';
                        input.dataset.key = key;
                        break;
                        
                    case 'number':
                        input = document.createElement('input');
                        input.type = 'number';
                        input.value = val ?? 0;
                        input.dataset.key = key;
                        break;
                        
                    case 'checkbox':
                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.checked = !!val;
                        input.dataset.key = key;
                        break;
                        
                    case 'dropdown':
                        input = document.createElement('select');
                        input.dataset.key = key;
                        if (def.nullable) {
                            const noneOpt = document.createElement('option');
                            noneOpt.value = '<None>';
                            noneOpt.textContent = '<None>';
                            input.appendChild(noneOpt);
                        }
                        if (def.options) {
                            for (const optVal of def.options) {
                                const opt = document.createElement('option');
                                opt.value = optVal;
                                opt.textContent = optVal;
                                if (optVal === val) opt.selected = true;
                                input.appendChild(opt);
                            }
                        }
                        if (val == null && def.nullable) {
                            input.value = '<None>';
                        }
                        break;
                        
                    case 'facets':
                        input = document.createElement('div');
                        input.className = 'compound';
                        const parts = (val || '0,0,0,0').split(',');
                        for (let i = 0; i < 4; i++) {
                            const fi = document.createElement('input');
                            fi.type = 'number';
                            fi.value = parts[i] || 0;
                            fi.dataset.key = key;
                            fi.dataset.facetIndex = i;
                            input.appendChild(fi);
                        }
                        break;
                        
                    case 'skill':
                        input = document.createElement('div');
                        input.className = 'compound';
                        let sp = ['', '0', 'False'];
                        if (val) sp = val.split(',');
                        
                        const sd = document.createElement('select');
                        sd.dataset.key = key;
                        sd.dataset.skillPart = 'name';
                        if (def.nullable) {
                            const noneOpt = document.createElement('option');
                            noneOpt.value = '<None>';
                            noneOpt.textContent = '<None>';
                            sd.appendChild(noneOpt);
                        }
                        if (def.options) {
                            for (const optVal of def.options) {
                                const opt = document.createElement('option');
                                opt.value = optVal;
                                opt.textContent = optVal;
                                if (optVal === sp[0]) opt.selected = true;
                                sd.appendChild(opt);
                            }
                        }
                        if (!val && def.nullable) sd.value = '<None>';
                        input.appendChild(sd);
                        
                        const sl = document.createElement('input');
                        sl.type = 'number';
                        sl.value = sp[1] || 0;
                        sl.dataset.key = key;
                        sl.dataset.skillPart = 'level';
                        input.appendChild(sl);
                        
                        const sb = document.createElement('input');
                        sb.type = 'checkbox';
                        sb.checked = sp[2] === 'True';
                        sb.dataset.key = key;
                        sb.dataset.skillPart = 'bool';
                        input.appendChild(sb);
                        break;
                        
                    case 'catid-array':
                    case 'dropdown-array':
                        input = createDropdownArrayField(key, def.options, val);
                        break;
                        
                    default:
                        input = document.createElement('span');
                        input.className = 'display-only';
                        input.textContent = '(unknown field type)';
                }
                
                formGrid.appendChild(input);
            }
        }
    </script>
</body>
</html>